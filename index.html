<!DOCTYPE html>
<html>
    <head>
        <!-- Required meta tags -->
        <meta charset="utf-8">
        <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

        <!-- Bootstrap CSS -->
        <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0/css/bootstrap.min.css" integrity="sha384-Gn5384xqQ1aoWXA+058RXPxPg6fy4IWvTNh0E263XmFcJlSAwiGgFAW/dAiS6JXm" crossorigin="anonymous">
        <title>Secret code 13+4</title>

        <!--font awesome-->
        <!-- Place your kit's code here -->
        <script src="https://kit.fontawesome.com/b02c78fa69.js" crossorigin="anonymous"></script>
    </head>
    <style>
        body {
            font-family: Microsoft JhengHei;
            background: url("image/bg.jpg");
            background-repeat: no-repeat;
            background-size: auto;
        }

        .container {
            background-color: rgba(202, 202, 200, 0.4);
            border-radius: 15px;
        }

        .btn-squared-default
        {
            width: 100px !important;
            height: 100px !important;
            font-size: 12px;
        }

        .btn-squared-default:hover
        {
            border: 3px solid white;
            font-weight: 800;
        }
        
        #eq {
            font-family: "Comic Sans MS";
            font-size: 1.2rem;
        }

        #eq p {
            transform: scale(.5, 10);
        }

        .number {
            width: 100px;
            height: 100px;
            font-size: 12px;
            background-color: blue;            
        }
        
        .dice {
            font-size: 55px;
        }

        .alreadyUsed {
            pointer-events: none;
            cursor: default;
            opacity: 0.4;
        }

        .dice-block {
            background-color: rgba(228, 227, 166, 0.4);
            margin: 10px;
            border-radius: 15px;
        }

        .my-custom-scrollbar {
            position: relative;
            height: 400px;
            overflow: auto;
        }

        .table-wrapper-scroll-y {
            display: block;
        }

        #back, #ckeck, #endRound, #start{
            font-size: 1.1rem;
        }

    </style>
    <body>

        <!-- Modal -->
        <div class="modal fade" id="exampleModal" tabindex="-1" role="dialog" aria-labelledby="exampleModalLabel" aria-hidden="true">
            <div class="modal-dialog" role="document">
            <div class="modal-content">
                <div class="modal-header">
                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
                </div>
                <div class="modal-body">
                
                </div>
                <div class="modal-footer">
                <button type="button" class="btn btn-success" data-dismiss="modal">OK</button>
                </div>
            </div>
            </div>
        </div>


        <div class="container p-1">
            <div class="row mt-3">
                <div class="col-lg-12 d-flex justify-content-center">

                    <p class="text-center">
                        <a href="#" class="op btn btn-squared-default btn-primary m-1" at="+">
                            <i class="fas fa-plus fa-5x"></i>
                            <br />
                            加號
                            <br />                        
                        </a>
                        <a href="#" class="op btn btn-squared-default btn-success m-1" at="-">
                            <i class="fas fa-minus fa-5x"></i>
                            <br />
                            減號
                            <br />
                        </a>
                        <a href="#" class="op btn btn-squared-default btn-info m-1" at="*">
                            <i class="fas fa-times fa-5x"></i>
                            <br />
                            乘號
                            <br />
                        </a>
                        <a href="#" class="op btn btn-squared-default btn-danger m-1" at="/">
                            <i class="fas fa-divide fa-5x"></i>
                            <br />
                            除號
                            <br />
                        </a>
                        <a href="#" class="op btn btn-squared-default btn-secondary m-1" at="(">
                            <i class="fas fa-angle-left fa-5x"></i>
                            <br />
                            左小括弧
                            <br />
                        </a>            
                        <a href="#" class="op btn btn-squared-default btn-secondary m-1" at=")">
                            <i class="fas fa-angle-right fa-5x"></i>
                            <br />
                            右小括弧
                            <br />
                        </a>
                    </p>
                </div>
            </div>
            
            <div class="row dice-block">
                <div class="col-lg-12 d-flex justify-content-center">
                    <a id="d1" href="#" class="dice btn btn-squared-default btn-info m-3 text-center">
                        9
                    </a>
                    <a id="d2" href="#" class="dice btn btn-squared-default btn-info m-3">
                       8
                    </a>
                    <a id="d3" href="#" class="dice btn btn-squared-default btn-info m-3">
                       7
                    </a>
                </div>
                <div class="col-lg-12 d-flex justify-content-center text-center">
                    <a id="d4" href="#" class="dice btn btn-squared-default btn-info m-3">
                        6
                    </a>
                    <a id="d5" href="#" class="dice btn btn-squared-default btn-info m-3">
                        5
                    </a>
                    <a id="d6" href="#" class="dice btn btn-squared-default btn-info m-3">
                        4
                    </a>
                </div>
            </div>

            <div class="row">
                <div class="offset-lg-2 col-lg-8 d-flex justify-content-center">
                    <div class="input-group mb-3">
                        <input id="eq" type="text" class="form-control" placeholder="Please enter your formula :)" aria-describedby="basic-addon2" disabled>
                        <div class="input-group-append">
                            <button id="back" class="btn btn-danger pl-3 pr-3" type="button"><i class="fas fa-backspace" style="font-size: 20px;"></i></button>
                        </div>
                        <div class="col-xs-6 input-group-append">
                          <button id="check" class="btn btn-success pl-3 pr-3" type="button">送出</button>
                        </div>
                        <div class="col-xs-6 input-group-append">
                            <button id="endRround" class="btn btn-info pl-3 pr-3" type="button">結束回合</button>
                        </div>
                    </div>
                </div>

                <div class="offset-lg-2 col-lg-8 d-flex justify-content-center mb-3">
                    <button id="start" class="btn btn-warning btn-lg btn-block" type="button">遊戲開始</button>
                </div>
            </div><!--end row-->

            <div class="row">
                <div class="offset-lg-2 col-lg-8">
                    <div class="info alert alert-info" role="alert">
                
                    </div>
                </div>
            </div>

            <div class="row">
                <div class="col-lg-12">
                    <div class="table-wrapper-scroll-y my-custom-scrollbar">
                        <table class="table table-bordered table-striped mb-0 text-center">
                          <thead>
                            <tr>
                              <th scope="col">#</th>
                              <th scope="col">Number</th>
                              <th scope="col">Player1</th>
                              <th scope="col">Player2</th>
                            </tr>
                          </thead>
                          <tbody class="game-td">
                            <tr>
                                <th scope="row">0</th>
                                <td>起點</td>
                                <td><i class="fas fa-circle"></i></td>
                                <td><i class="far fa-circle"></i></td>
                            </tr>
        
                          </tbody>
                        </table>              
                    </div> <!--end table-wrapper-->
                </div>
            </div>
        </div> <!--end container-->
        <script src="https://code.jquery.com/jquery-3.2.1.slim.min.js" integrity="sha384-KJ3o2DKtIkvYIK3UENzmM7KCkRr/rE9/Qpg6aAZGJwFDMVNA/GpGFF93hXpG5KkN" crossorigin="anonymous"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.12.9/umd/popper.min.js" integrity="sha384-ApNbgh9B+Y1QKtv3Rn7W3mgPxhU9K/ScQsAP7hUibX39j7fakFPskvXusvfa0b4Q" crossorigin="anonymous"></script>
        <script src="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0/js/bootstrap.min.js" integrity="sha384-JZR6Spejh4U02d8jOt6vLEHfe/JQGiRRSQQxSfFWpi1MquVdAyjUar5+76PVCmYl" crossorigin="anonymous"></script>    
    </body>
    <script>

        class Player {
            constructor(id, token) {
                this.id = id;
                this.stage = 0;
                this.round = 0;
                this.dices = [1, 2, 3, 4, 5, 6];
            }

            start_round() {
                this.round++;
                this.dices = [1, 2, 3, 4, 5, 6];
                ClearDiceStatus();
            }

            reset_dice() {
                // All used
                $('.dice').addClass("alreadyUsed btn-light");
                // alert("reset");
                console.log(this.dices);
                for (var i = 0; i < (this.dices).length; i++) {
                    $('#d'+(this.dices)[i]).removeClass("alreadyUsed btn-light");
                }
                $("#eq").val("");
            }

            match_answer(ans) {
                var selector = 'td.point-'+(this.stage+1);
                var num = $(selector).text(); 
                if (ans == num) {
                    var tmp = [];
                    $( ".dice" ).each(function(index) {
                        if (!$(this).hasClass("alreadyUsed")) {
                            var id = $(this).attr('id');
                            tmp.push(id[1]);
                        }
                    });
                    this.dices = tmp;
                    $("#eq").val("");
                    if (this.id == 1) {
                        $("td.s"+this.id+"-"+(this.stage+1)).html("<i class=\"fas fa-circle\"></i>");
                    }
                    else if (this.id == 2) {
                        $("td.s"+this.id+"-"+(this.stage+1)).html("<i class=\"far fa-circle\"></i>");
                    }
                    this.stage++;
                    this.show_status();
                    if (this.stage == LENGTH) {
                        Message("恭喜你!! 挑戰成功!");
                        this.game_over();
                    }
                    else {
                        Message("Great! 前進一步。");
                    }
                }
                else {
                    Message("密碼不正確，再試試看吧!");
                    this.reset_dice();
                }
            }

            show_status() {
                $('.info').html("當前玩家：<strong>Player" + this.id + "</strong> <br/> 第 " + this.round + " 回合 <br /> 目前進度 <strong>"+this.stage+"/"+LENGTH + "</strong>, 下一個密碼是 <strong style=\"color: red;\">"+$('td.point-'+(this.stage+1)).text()+"</strong>");
            }

            game_over() {
                $("#check").attr("disabled", true);
                $("#endRround").attr("disabled", true);
                $("#back").attr("disabled", true);
            }
        };

        var p1, p2;
        var currentPlayer = -1;
        var LENGTH = 10;

        var d1 = [1, 3, 5, 7, 9, 2];
        var d2 = [4, 6, 8, 1, 3, 5];
        var d3 = [7, 9, 2, 4, 6, 8];
        var d4 = [1, 3, 5, 7, 9, 2];
        var d5 = [4, 6, 8, 1, 3, 5];
        var d6 = [7, 9, 2, 4, 6, 8];

        function Roll() {
            $('#d1').text(d1[Math.floor(Math.random()*7)]);
            $('#d2').text(d2[Math.floor(Math.random()*7)]);
            $('#d3').text(d3[Math.floor(Math.random()*7)]);
            $('#d4').text(d4[Math.floor(Math.random()*7)]);
            $('#d5').text(d5[Math.floor(Math.random()*7)]);
            $('#d6').text(d6[Math.floor(Math.random()*7)]);
        }

        $(function() {
            Roll();
        });

        function Message(s) {
            $(".modal-body").text(s);
            $("#exampleModal").modal('toggle');
        };

        function ClearDiceStatus() {
            $('.dice').removeClass("alreadyUsed btn-light");
            $('#eq').val("");
        }

        function IsNumber (n) {
            for (var i = 0; i < n.length; i++) {
                if (n[i] < '0' || n[i] > '9') {
                    return false;
                }
            }
            return true;
        };

        $('#check').on('click', function (e) {
            number_lock = false;
            var eq = $('#eq').val();

            var sep = ['+', '-', '*', '/', '(', ')'];
            var arr = [];
            var tmp = "";
            for (var i = 0; i < eq.length; i++) {
                if (eq[i] >= '0' && eq[i] <= '9') {
                    tmp += eq[i];
                }
                else if (sep.includes(eq[i])) {
                    if (tmp != "") {
                        arr.push(tmp);
                        arr.push(eq[i]);
                        tmp = "";
                    }
                    else {
                        arr.push(eq[i]);
                    }
                }
            }
            if (tmp != "")
                arr.push(tmp)
            console.log(arr);

            var priority_map = new Map();
            priority_map.set('+', 1);
            priority_map.set('-', 1);
            priority_map.set('*', 2);
            priority_map.set('/', 2);
            priority_map.set('(', 0);

            var postfix = [];
            var opStack = [];
            for (var i = 0; i < arr.length; i++) {
                if (IsNumber(arr[i])) {
                    postfix.push(arr[i]);
                }
                else if (arr[i] == '(') {
                    opStack.push(arr[i]);
                }
                else if (arr[i] == ')') {
                    var topOp = opStack.pop();
                    while (topOp != '(') {
                        postfix.push(topOp);
                        if (opStack.length == 0)
                            break;
                        topOp = opStack.pop();
                    }
                }
                else {
                    while(opStack.length != 0 && (priority_map.get(opStack[opStack.length-1]) >= priority_map.get(arr[i]))) {
                        postfix.push(opStack.pop());
                    }
                    opStack.push(arr[i]);
                }
            }
            while (opStack.length != 0)
                postfix.push(opStack.pop());
            console.log(postfix);

            var stack = [];
            for (var i = 0; i < postfix.length; i++) {
                if (sep.includes(postfix[i])) {
                    var a = stack.pop();
                    var b = stack.pop();
                    switch (postfix[i]) {
                        case '+':
                            stack.push(a + b);
                            break;
                        case '-':
                            stack.push(b - a);
                            break;
                        case '*':
                            stack.push(a * b);
                            break;
                        case '/':
                            stack.push(b / a);
                            break;
                    }
                }
                else
                    stack.push(parseInt(postfix[i]));
            }
            if (stack.length == 1 && !isNaN(stack[0]))
            {
                console.log(stack);
                var a = stack.pop();
                console.log(a);
                
                if (currentPlayer == 1) {
                    p1.match_answer(a);
                }
                else if (currentPlayer == 2) {
                    p2.match_answer(a);
                }
                else {
                    Message(a);
                    $("#eq").val("");
                    ClearDiceStatus();
                }
            }
            else {
                if (currentPlayer == 1) {
                    p1.reset_dice();
                }
                else if (currentPlayer == 2) {
                    p2.reset_dice();
                }
                else {
                    $("#eq").val("");
                    ClearDiceStatus();
                }
                Message("格式有誤，請重新輸入!!")
                console.log("something wrong.");
            }
                
        });

        var number_lock = false;
        $('.op').on('click', function (e) {
            $('#eq').val($('#eq').val() + $(this).attr("at"));
            number_lock = false;
        });

        $('.dice').on('click', function (e) {
            if (!number_lock) {
                number_lock = true;
                $('#eq').val($('#eq').val() + $.trim($(this).text()));
                $(this).addClass("alreadyUsed btn-light");
                num_lock = true;
            }
            else {
                $('#back').click();
                number_lock = false;
            }
        });

        $('#back').on('click', function (e) {
            number_lock = false;
            if (currentPlayer == 1) {
                p1.reset_dice();
            }
            else if (currentPlayer == 2) {
                p2.reset_dice();
            }
            else {
                ClearDiceStatus();
            }
            $('#eq').val("");
        });

        $('#start').on('click', function(e) {
            // 產生地圖
            $(".game-td").html("");
            $(".game-td").append("<tr>  \
                      <th scope=\"row\">0</th>  \
                      <td>起點</td>  \
                      <td><i class=\"fas fa-circle\"></i></td>  \
                      <td><i class=\"far fa-circle\"></i></td>  \
                    </tr>");
            var path = [];
            var rn;
            for (var i = 0; i < LENGTH; i++) {
                if (i == LENGTH-1)
                    rn = 20;
                else
                    rn = Math.floor(Math.random()*19)+1
                path.push(rn);// 1-19
                $(".game-td").append("<tr>  \
                      <th scope=\"row\">"+ (i+1) +"</th>  \
                      <td class=\"point-"+(i+1)+"\">" + rn + "</td>  \
                      <td class=\"s1-"+(i+1)+"\"></td>  \
                      <td class=\"s2-"+(i+1)+"\"></td>  \
                    </tr>");
            }
            console.log(path);
            
            // 遊戲初始
            $(this).text("重新開始");
            $(this).removeClass("btn-warning").addClass("btn-danger");
            number_lock = false;
            Message("現在輪到Player1");
            p1 = new Player(1);
            p2 = new Player(2);
            currentPlayer = 1;
            p1.start_round();
            Roll();
            ClearDiceStatus();
            p1.show_status();
            console.log(p1.id);
            
            $("#check").attr("disabled", false);
            $("#endRround").attr("disabled", false);
            $("#back").attr("disabled", false);

        });

        $('#endRround').on('click', function(e) {
            number_lock = false;
            if (jQuery.isEmptyObject(p1)) {
                Message("Click start first.");
                return;
            }
            
            // // 清空選取
            ClearDiceStatus();

            // // 輪替
            currentPlayer = (currentPlayer == 1) ? 2 : 1;
            Message("現在輪到Player"+currentPlayer);

            // // 骰
            Roll();

            // 
            if (currentPlayer == 1) {
                p1.start_round();
                p1.show_status();
            }
            else if (currentPlayer == 2) {
                p2.start_round();
                p2.show_status();
            }
        });
    </script>
</html>